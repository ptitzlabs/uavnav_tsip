<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TSIP Decoder: TSIP Decoder</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TSIP Decoder
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">TSIP Decoder </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="intro_sec"></a>
Introduction</h1>
<p>This program is designed to read and decode TSIP data packets.</p>
<h1><a class="anchor" id="install_sec"></a>
Installation</h1>
<p>Both .pro files to compile with QT and a simple Makefile are included. To compile the program simply run make from the main program directory.</p>
<h1><a class="anchor" id="Decoder"></a>
Decoder</h1>
<p>The packet is decoded first. The decoding process removes the escape characters and maps the flags, marking the packet starting and ending points.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">while</span> (i &lt; *raw_len) {</div><div class="line">    <span class="comment">// check for DLE</span></div><div class="line">    <span class="keywordflow">if</span> (raw[i] == <a class="code" href="tsip__read_8h.html#add7018db64fb17dd1e4664b4494be0ee">DLE</a>) {</div><div class="line">      <span class="comment">// check if there are still bytes left in the buffer</span></div><div class="line">      <span class="keywordflow">if</span> (i + 1 &lt; *raw_len) {</div><div class="line">        <span class="comment">// check the byte after the DLE</span></div><div class="line">        i++;</div><div class="line">        <span class="keywordflow">switch</span> (raw[i]) {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="tsip__read_8h.html#af02558e983dd26832a852bf186ed6726">ETX</a>:</div><div class="line">          <span class="comment">// end of packet</span></div><div class="line">          flag[*flag_count] = *processed_len;</div><div class="line">          flag_type[*flag_count] = <a class="code" href="tsip__decode_8h.html#aaadb960acba914ffc497ac7b256cdd55a5ed0c9e4189b86c84f9ded0501e9dd18">end_flag</a>;</div><div class="line">          (*flag_count)++;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="tsip__read_8h.html#add7018db64fb17dd1e4664b4494be0ee">DLE</a>:</div><div class="line">          <span class="comment">// escape flag, don&#39;t do anything</span></div><div class="line">          processed[(*processed_len)++] = raw[i];</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">          <span class="comment">// data start</span></div><div class="line">          flag[*flag_count] = *processed_len;</div><div class="line">          flag_type[*flag_count] = <a class="code" href="tsip__decode_8h.html#aaadb960acba914ffc497ac7b256cdd55a4b507f9b9a7feb19dc7248d7de612717">start_flag</a>;</div><div class="line">          (*flag_count)++;</div><div class="line">          processed[(*processed_len)++] = raw[i];</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        i++;</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">// end of raw data, just store it as-is and figure it out</span></div><div class="line">        <span class="comment">// later</span></div><div class="line">        *hanging_dle = <span class="keyword">true</span>;</div><div class="line">        processed[(*processed_len)++] = raw[i];</div><div class="line">        i++;</div><div class="line">      }</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">      processed[(*processed_len)++] = raw[i];</div><div class="line">      i++;</div><div class="line">    }</div><div class="line">  }</div></div><!-- fragment --><p> Once the data block is processed, the previous data buffer is checked. This is done to ensure that if a packet is spread across several blocks it is still identified and parsed.</p>
<div class="fragment"><div class="line">      <span class="comment">// check if the last block ended on a DLE flag</span></div><div class="line">      <a class="code" href="tsip__decode_8h.html#a812dd629379f16c30e1dba03db6745fc">hanging_dle_test</a>(processed, processed_len, flag, flag_type, flag_count);</div><div class="line">      <span class="comment">// make sure there are some flags found</span></div><div class="line">      <span class="keywordflow">if</span> ((*flag_count) &gt; 0) {</div><div class="line">        <span class="comment">// check if there&#39;s data from before</span></div><div class="line">        <span class="keywordflow">if</span> (g_inter_buffer_len &gt; 0) {</div><div class="line"></div><div class="line">          <span class="keywordflow">if</span> (flag_type[0] == <a class="code" href="tsip__decode_8h.html#aaadb960acba914ffc497ac7b256cdd55a5ed0c9e4189b86c84f9ded0501e9dd18">end_flag</a>) {</div><div class="line">            <span class="comment">// patch the data together</span></div><div class="line">            memcpy(g_inter_buffer + g_inter_buffer_len, processed,</div><div class="line">                   flag[0] * <span class="keyword">sizeof</span>(uint8_t));</div><div class="line">            g_inter_buffer_len += flag[0];</div><div class="line">            <span class="comment">// validate and parse</span></div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="tsip__decode_8h.html#a41c4ae0abb32c8c722925578007e711b">validate_packet</a>(g_inter_buffer, 0, g_inter_buffer_len) == 0) {</div><div class="line">              <a class="code" href="tsip__read_8h.html#aaf187111fc27885f025120a9bf69de0d">ParseTsipData</a>(g_inter_buffer, g_inter_buffer_len - 4);</div><div class="line">              packet_counter++;</div><div class="line">            }</div><div class="line">            <span class="comment">// reset buffer</span></div><div class="line">            g_inter_buffer_len = 0;</div><div class="line">            g_inter_buffer_dle = <span class="keyword">false</span>;</div><div class="line">          }</div><div class="line">        }</div></div><!-- fragment --><p> If a complete packet is identified, it is validated and parsed. The validation includes checking that the packet size does not exceed minimum or maximum limits, that the first byte ID is legal and a CRC checksum comparison.</p>
<div class="fragment"><div class="line">  <span class="comment">// packet size</span></div><div class="line">  <span class="keywordflow">if</span> (len &lt; 6 || len &gt; <a class="code" href="tsip__decode_8h.html#a87f68e96fb938eddc39ad1f19d923a96">MAX_DATA_SIZE</a> + 6) {</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="tsip__decode_8h.html#ac1accdfaf17cd8ccf452c605fa935233a06e8eebf569c66387fe7e38059ceed79">size_mismatch</a>;</div><div class="line">  }</div><div class="line">  <span class="comment">// ID</span></div><div class="line">  <span class="keywordflow">if</span> (buffer[start] == <a class="code" href="tsip__read_8h.html#add7018db64fb17dd1e4664b4494be0ee">DLE</a>) {</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="tsip__decode_8h.html#ac1accdfaf17cd8ccf452c605fa935233aa7c3ec9f75a85e0e38eb97a1d7bd7490">illegal_id</a>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// chksum</span></div><div class="line">  uint32_t chksum_start = end - 4;</div><div class="line">  uint32_t chksum_int = <a class="code" href="util_8h.html#ad96587305bb46bd47c2069e0aafd6530">arr_to_int</a>(buffer + chksum_start, 4);</div><div class="line">  uint32_t chksum_chk = <a class="code" href="util_8h.html#aa1921745f0c9cd9f201d624ca86dc40b">crc32</a>(buffer, start, chksum_start);</div><div class="line">  <span class="keywordflow">if</span> (chksum_int != chksum_chk) {</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="tsip__decode_8h.html#ac1accdfaf17cd8ccf452c605fa935233a732565fcd9231ccc944acf3624b80300">chksum_mismatch</a>;</div><div class="line">  }</div></div><!-- fragment --><p> If the packet is not correct, a flag indicating the failure mode is returned. After validating the packets that might have started in the previous block, the current block is scanned for packets, which are also validated and parsed.</p>
<div class="fragment"><div class="line">        <span class="comment">// check the uninterrupted packets</span></div><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; (*flag_count) - 1; i++) {</div><div class="line">          <span class="keywordflow">if</span> (flag_type[i] == <a class="code" href="tsip__decode_8h.html#aaadb960acba914ffc497ac7b256cdd55a4b507f9b9a7feb19dc7248d7de612717">start_flag</a> &amp;&amp; flag_type[i + 1] == <a class="code" href="tsip__decode_8h.html#aaadb960acba914ffc497ac7b256cdd55a5ed0c9e4189b86c84f9ded0501e9dd18">end_flag</a>) {</div><div class="line">            <span class="comment">// uninterrupted packet, validate and parse</span></div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="tsip__decode_8h.html#a41c4ae0abb32c8c722925578007e711b">validate_packet</a>(processed, flag[i], flag[i + 1]) == 0) {</div><div class="line">              <a class="code" href="tsip__read_8h.html#aaf187111fc27885f025120a9bf69de0d">ParseTsipData</a>(processed + flag[i], flag[i + 1] - flag[i] - 4);</div><div class="line">              packet_counter++;</div><div class="line">            }</div><div class="line">          }</div><div class="line">        }</div></div><!-- fragment --> <h1><a class="anchor" id="Tests"></a>
Tests</h1>
<p>The tests included are the output and the speed tests. Two test data files are included in "data" folder: the tsip_sample with 3 valid data blocks and the tsip_sample_ext with 30000 blocks.</p>
<p>The output test is run on the shorter block, while the timing test is run on the longer one. The shorter output test can be run by appending a binary filename as a program parameter for running extra tests.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">if</span> (argc &gt; 1) {</div><div class="line">    <span class="comment">// load a provided file</span></div><div class="line">    <a class="code" href="uavnav__main_8c.html#aad6066d9ede8cbf9b9d5e4fa28236380">test_data_load</a>(argv[1]);</div><div class="line">  } <span class="keywordflow">else</span> {</div><div class="line">    <span class="comment">// or a default one if none provided</span></div><div class="line">    <a class="code" href="uavnav__main_8c.html#aad6066d9ede8cbf9b9d5e4fa28236380">test_data_load</a>(<span class="stringliteral">&quot;data/tsip_sample&quot;</span>);</div><div class="line">  }</div></div><!-- fragment --><p>The tests are run by executing the TaskUplink200Hz() command. This function starts the threads and keeps running until the entire data set is decoded.</p>
<div class="fragment"><div class="line">  g_data_read_seq = 0;</div><div class="line">  <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; <a class="code" href="tsip__decode_8h.html#ab60b5074c740fd36061f48f90d1a0b21">N_THREADS</a>; i++) {</div><div class="line">    ints[i] = i;</div><div class="line">    pthread_create(&amp;thread[i], NULL, <a class="code" href="tsip__decode_8h.html#a12e6599a2b96dd309e86e6fbb868a5d8">extract_data</a>, &amp;ints[i]);</div><div class="line">  }</div></div><!-- fragment --><p> The example program output is shown below:</p>
<pre class="fragment">Running verbose test
Loaded file data/tsip_sample
Size: 135
ID1: 165 ID2: 9 CHKSUM: 0xe85817fd
56 96 8a f1
cb 6e 13 50
8f 3c 84 44
c1 03 7c fc
3e 00 db 04
1c 05 00 76
1d 10 00 ff
ff 00 00 00
00 00 00 00
00 b1 46 d6
43 20 4e

ID1: 165 ID2: 10 CHKSUM: 0xc4c61b3e
db 04 1c 05
f9 f6 6d 44
00 00 c5 0a
76 1d 10 00
20 4e

ID1: 57 ID2: 2 CHKSUM: 0x476753ec
64 61 3e 0f
c4 c6 8a 40


Decoded 3 packets

Running a timed test
Loaded file data/tsip_sample_ext
Size: 1350000
Decoded 29535 packets
Time taken 0 seconds 9 milliseconds
</pre><p>Note that the tsip_sample_ext file actually contains 30000 packet samples, so the program may still needs some improvements in that regard. The main problem comes from the fact that a single packet may span several blocks of data read from the COM port, and separate blocks must be merged without losing data. Every possible condition must be taken into account. The decoder functionality and methods are described in the following section.</p>
<p>The verbose test shows that the packets are interpreted correctly. The timed test allows to compare the performance for different setup parameters, defined in advance.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define N_THREADS 2</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define BLOCK_SIZE 2048</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MAX_COM_SIZE 512</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define MAX_DATA_SIZE 256</span></div></div><!-- fragment --><p> The number of threads is defined by the variable N_THREADS. In theory spreading the load across several threads should increase the execution efficiency and reduce the execution times. In practice, a lot of this depends on the hardware architecture. On this machine (Intel(R) Core(TM) i7-3610QM CPU @ 2.30GHz running Debian GNU/Linux) two threads performed slightly faster than a single thread, and the performance started to decrease once the number of threads exceeded 4.</p>
<p>The BLOCK_SIZE variable specifies the data block size to be processed by a single thread. It was found that larger block size results in a better performance. Which is natural, since it takes less effort to analyze one continuous data block rather than a series of discontinuous ones.</p>
<p>The MAX_COM_SIZE parameter is the maximum allowable data size that is allowed to read from the COM port in one go. While the MAX_DATA_SIZE parameter is used to define the maximum packet size, and it is used for data validation and sanity checks. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
